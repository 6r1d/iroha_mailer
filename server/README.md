# Iroha Mailer server

This directory contains the server-side code
for the Iroha news mailer.
Generally, this code is running in Docker, but it can run separately when the requirements are met.

It has three key functions:

* generating the mail and print templates
* sending them out
* letting people subscribe and unsubscribe

The generation is triggered by the CI side of the code, using the HTTP API with TOTP keys.
Additional HTTPS protection remains the choice and responsibility of the user,
as there's more than one option for that.

Current version is available at the [`iroha_mailer`](https://hub.docker.com/r/iamgrid/iroha_mailer) [DockerHub](https://hub.docker.com) repository.

It depends on:

* a TOML configuration file
* a list of subscribers in `yaml` format
* a `secret` file for the OTP feature generated by the `secret_gen.py` file

You have to generate the secret at least once,
and you should periodically update it for the sake of security.

## Configuration structure

The configuration is split on three sections, `http`, `smtp`, `mail`.

The `http` section configures an internal HTTP server, which is used
for the subscription frontend and the API.

The `smtp` section lets you configure the `SMTP` connection and nothing else.
Please take note that the `from` field can be overridden in other section, `mail`.

The `mail` section allows you configure the key things, related to your email:

* `email_from` overrides your email address, which can be useful when you need to use an email alias
* `root_url` sets a root URL of the mailer server, so that an unsubscription feature can work properly
* `enable_list_unsibscribe` parameter lets you
   enable or disable [`list-unsubscribe`](https://www.ietf.org/rfc/rfc2369.txt) header for your emails,
   which is useful for SEO.

When performing the deployment, you **have to update** the `root_url` after an installation with `mailer_subdomain.your_domain.org` or
`your_domain.org/mailer_route`. Leaving `list-unsubscribe` headers as incorrect will only
look broken or spammy to modern email clients.

In case you are using GMail, you'll have to enable the [app passwords](https://support.google.com/accounts/answer/185833?visit_id=638308904181091031-2425311013&p=InvalidSecondFactor&rd=1) feature for the SMTP functions to work properly. Only SMTP is used, as the GMail API has certain limitations and the mailing function is relatively easy to replace.

```toml
[http]
port = 8080
host = "0.0.0.0"

[smtp]
host = 'smtp.gmail.com'
ssl = true
user = 'mailer@company.org'
password = 'YOUR_PASS'

[mail]
email_from = 'mailer_address@test_mailer.org'
root_url = "test_mailer.org"
enable_list_unsubscribe = true
```

## Subscriber list structure

The subscriber list is a `yaml` file containing a list of emails of the subscribers
and the hashes of each email for the minimal security of unsubscribing.

```yaml
- email: abc@example.com
  hash: 9eceb13483d7f187ec014fd6d4854d1420cfc634328af85f51d0323ba8622e21
- email: def@example.com
  hash: 02193528ea83dd659b8ce164f829e8927b5d57467ce45a6c50ddfc8b9b0d003a
- email: ghi@example.com
  hash: b85126a0ad08c941d33860b712b6952e66b0efe341b05b353864d12811af99c8
```

## Container-related commands

These are the commands used to configure Docker as expected.

The commands are here for the demonstration and aren't
different from the normal use of Docker.

`build` and `push` commands are using version `0.1.6` for the example.

### Building a container

```bash
docker buildx build . --tag 'iamgrid/iroha_mailer:v0.1.6'
```

### Running a container

```bash
docker run \
       --init --expose 8080 \
       -p 8080:8080 \
       -p 465:465 \
       -v ./config/config.toml:/etc/mailer/config.toml \
       -v ./config/emails.yaml:/etc/mailer/emails.yaml \
       -v ./config/secret.txt:/run/secrets/mailer_secret \
       'iamgrid/iroha_mailer:v0.1.6'
```

### Pushing an updated container

```bash
docker push 'iamgrid/iroha_mailer:v0.1.6'
```
